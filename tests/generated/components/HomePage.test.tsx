// AUTO-GENERATED BY generate-tests.ts
// Source: src/components/HomePage.tsx
// DO NOT EDIT MANUALLY - 修改将在下次生成时被覆盖

import { render, screen, fireEvent } from '@testing-library/react';
import { vi } from 'vitest';
import HomePage from '../../../src/components/HomePage';
import '@testing-library/jest-dom';

// Mock the ProjectCard component
vi.mock('../../../src/components/ProjectCard', () => ({
  default: ({ project, onClick }: { project: any; onClick: () => void }) => (
    <button data-testid={`project-${project.id}`} onClick={onClick}>
      {project.title}
    </button>
  ),
}));

// Mock the useProject hook from ProjectContext
vi.mock('../../../src/contexts/ProjectContext', () => ({
  useProject: vi.fn(),
}));

// Helper to set the mock implementation of useProject
const setMockRecentProjects = (projects: any[]) => {
  const { useProject } = await import('../../../src/contexts/ProjectContext');
  useProject.mockReturnValue({
    getRecentProjects: (_count: number) => projects,
  });
};

describe('HomePage component', () => {
  const onStartBuilding = vi.fn().mockResolvedValue(undefined);
  const onViewAllProjects = vi.fn();
  const onProjectClick = vi.fn();

  beforeEach(() => {
    vi.clearAllMocks();
    // Default to no recent projects
    setMockRecentProjects([]);
  });

  it('renders placeholder and build button disabled when input is empty', () => {
    render(
      <HomePage
        onStartBuilding={onStartBuilding}
        onViewAllProjects={onViewAllProjects}
        onProjectClick={onProjectClick}
      />
    );

    // Placeholder text should be present
    expect(
      screen.getByText(/让我们构建一个/, { exact: false })
    ).toBeInTheDocument();

    // Build button should be disabled
    const buildButton = screen.getByRole('button', { name: /立即构建/ });
    expect(buildButton).toBeDisabled();
  });

  it('renders recent projects list and view all button when projects exist', () => {
    const mockProjects = [
      { id: '1', title: 'Project One' },
      { id: '2', title: 'Project Two' },
    ];
    setMockRecentProjects(mockProjects);

    render(
      <HomePage
        onStartBuilding={onStartBuilding}
        onViewAllProjects={onViewAllProjects}
        onProjectClick={onProjectClick}
      />
    );

    // Project cards should be rendered
    mockProjects.forEach((p) => {
      expect(screen.getByTestId(`project-${p.id}`)).toHaveTextContent(p.title);
    });

    // View all button should be present
    const viewAllButton = screen.getByRole('button', { name: /查看全部/ });
    expect(viewAllButton).toBeInTheDocument();
  });

  test.each`
    inputValue        | expectedDisabled
    ${''}            | ${true}
    ${'   '}         | ${true}
    ${'Hello'}       | ${false}
    ${'  Test  '}     | ${false}
  `('build button $expectedDisabled when input is "$inputValue"', async ({ inputValue, expectedDisabled }) => {
    render(
      <HomePage
        onStartBuilding={onStartBuilding}
        onViewAllProjects={onViewAllProjects}
        onProjectClick={onProjectClick}
      />
    );

    const input = screen.getByRole('textbox');
    fireEvent.change(input, { target: { value: inputValue } });

    const buildButton = screen.getByRole('button', { name: /立即构建/ });
    if (expectedDisabled) {
      expect(buildButton).toBeDisabled();
    } else {
      expect(buildButton).toBeEnabled();
    }
  });

  it('submits input on button click and resets state after creation', async () => {
    render(
      <HomePage
        onStartBuilding={onStartBuilding}
        onViewAllProjects={onViewAllProjects}
        onProjectClick={onProjectClick}
      />
    );

    const input = screen.getByRole('textbox');
    fireEvent.change(input, { target: { value: 'Test Prompt' } });

    const buildButton = screen.getByRole('button', { name: /立即构建/ });
    fireEvent.click(buildButton);

    // onStartBuilding should be called with trimmed value
    expect(onStartBuilding).toHaveBeenCalledWith('Test Prompt');

    // Button should show "创建中..." and be disabled
    expect(buildButton).toHaveTextContent('创建中...');
    expect(buildButton).toBeDisabled();

    // Wait for the async function to resolve
    await waitFor(() => expect(onStartBuilding).toHaveBeenCalledTimes(1));

    // After creation, button label should revert and input cleared
    expect(buildButton).toHaveTextContent('立即构建');
    expect(buildButton).toBeDisabled(); // still disabled because input is empty
    expect(input).toHaveValue('');
  });

  it('submits input when Enter key is pressed without Shift', async () => {
    render(
      <HomePage
        onStartBuilding={onStartBuilding}
        onViewAllProjects={onViewAllProjects}
        onProjectClick={onProjectClick}
      />
    );

    const input = screen.getByRole('textbox');
    fireEvent.change(input, { target: { value: 'Enter Prompt' } });

    fireEvent.keyDown(input, { key: 'Enter', code: 'Enter' });

    await waitFor(() => expect(onStartBuilding).toHaveBeenCalledWith('Enter Prompt'));
  });

  it('does not submit input when Enter key is pressed with Shift', async () => {
    render(
      <HomePage
        onStartBuilding={onStartBuilding}
        onViewAllProjects={onViewAllProjects}
        onProjectClick={onProjectClick}
      />
    );

    const input = screen.getByRole('textbox');
    fireEvent.change(input, { target: { value: 'Shift Enter' } });

    fireEvent.keyDown(input, { key: 'Enter', code: 'Enter', shiftKey: true });

    await waitFor(() => expect(onStartBuilding).not.toHaveBeenCalled());
  });

  it('calls onProjectClick when a project card is clicked', () => {
    const mockProjects = [{ id: '1', title: 'Project One' }];
    setMockRecentProjects(mockProjects);

    render(
      <HomePage
        onStartBuilding={onStartBuilding}
        onViewAllProjects={onViewAllProjects}
        onProjectClick={onProjectClick}
      />
    );

    const projectButton = screen.getByTestId('project-1');
    fireEvent.click(projectButton);

    expect(onProjectClick).toHaveBeenCalledWith(mockProjects[0]);
  });

  it('calls onViewAllProjects when view all button is clicked', () => {
    const mockProjects = [{ id: '1', title: 'Project One' }];
    setMockRecentProjects(mockProjects);

    render(
      <HomePage
        onStartBuilding={onStartBuilding}
        onViewAllProjects={onViewAllProjects}
        onProjectClick={onProjectClick}
      />
    );

    const viewAllButton = screen.getByRole('button', { name: /查看全部/ });
    fireEvent.click(viewAllButton);

    expect(onViewAllProjects).toHaveBeenCalledTimes(1);
  });
});