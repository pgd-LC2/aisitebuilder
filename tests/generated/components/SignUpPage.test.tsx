// AUTO-GENERATED BY generate-tests.ts
// Source: src/components/SignUpPage.tsx
// DO NOT EDIT MANUALLY - 修改将在下次生成时被覆盖

import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { vi } from 'vitest';
import SignUpPage from '../../../src/components/SignUpPage';

// Mock the AuthContext to provide a fake signUp function
vi.mock('../../../src/contexts/AuthContext', () => ({
  useAuth: vi.fn(),
}));

describe('SignUpPage', () => {
  const onSwitchToLogin = vi.fn();
  const mockSignUp = vi.fn();

  beforeEach(() => {
    vi.clearAllMocks();
    // Provide the mocked signUp function via useAuth
    const { useAuth } = await import('../../../src/contexts/AuthContext');
    useAuth.mockReturnValue({ signUp: mockSignUp });
  });

  test('renders the sign-up form correctly', () => {
    render(<SignUpPage onSwitchToLogin={onSwitchToLogin} />);

    // Headings and placeholders
    expect(screen.getByRole('heading', { name: /创建账户/i })).toBeInTheDocument();
    expect(screen.getByPlaceholderText('your@email.com')).toBeInTheDocument();
    expect(screen.getByPlaceholderText('至少 6 个字符')).toBeInTheDocument();
    expect(screen.getByPlaceholderText('再次输入密码')).toBeInTheDocument();

    // Submit button
    const submitButton = screen.getByRole('button', { name: /注册/i });
    expect(submitButton).toBeEnabled();
    expect(submitButton).toBeInTheDocument();

    // Switch to login button
    const loginButton = screen.getByRole('button', { name: /立即登录/i });
    expect(loginButton).toBeInTheDocument();
  });

  test.each`
    password        | confirmPassword | errorMessage
    ${'123456'}     | ${'654321'}     | ${'两次输入的密码不一致'}
    ${'123'}        | ${'123'}        | ${'密码长度至少为 6 个字符'}
  `('shows error when $errorMessage', async ({ password, confirmPassword, errorMessage }) => {
    render(<SignUpPage onSwitchToLogin={onSwitchToLogin} />);

    fireEvent.change(screen.getByLabelText('邮箱地址'), { target: { value: 'test@example.com' } });
    fireEvent.change(screen.getByLabelText('密码'), { target: { value: password } });
    fireEvent.change(screen.getByLabelText('确认密码'), { target: { value: confirmPassword } });

    fireEvent.click(screen.getByRole('button', { name: /注册/i }));

    const errorAlert = await screen.findByText(errorMessage);
    expect(errorAlert).toBeInTheDocument();

    // signUp should not be called
    expect(mockSignUp).not.toHaveBeenCalled();
  });

  test('shows loading state and disables submit button', async () => {
    // Mock signUp to resolve after a delay
    mockSignUp.mockResolvedValueOnce({ error: undefined });

    render(<SignUpPage onSwitchToLogin={onSwitchToLogin} />);

    fireEvent.change(screen.getByLabelText('邮箱地址'), { target: { value: 'test@example.com' } });
    fireEvent.change(screen.getByLabelText('密码'), { target: { value: 'abcdef' } });
    fireEvent.change(screen.getByLabelText('确认密码'), { target: { value: 'abcdef' } });

    const submitButton = screen.getByRole('button', { name: /注册/i });
    fireEvent.click(submitButton);

    expect(submitButton).toBeDisabled();
    expect(submitButton).toHaveTextContent('注册中...');
  });

  test('displays success page after successful sign-up', async () => {
    mockSignUp.mockResolvedValueOnce({ error: undefined });

    render(<SignUpPage onSwitchToLogin={onSwitchToLogin} />);

    fireEvent.change(screen.getByLabelText('邮箱地址'), { target: { value: 'test@example.com' } });
    fireEvent.change(screen.getByLabelText('密码'), { target: { value: 'abcdef' } });
    fireEvent.change(screen.getByLabelText('确认密码'), { target: { value: 'abcdef' } });

    fireEvent.click(screen.getByRole('button', { name: /注册/i }));

    const successHeading = await screen.findByRole('heading', { name: /注册成功！/i });
    expect(successHeading).toBeInTheDocument();

    const loginButton = screen.getByRole('button', { name: /前往登录/i });
    fireEvent.click(loginButton);

    expect(onSwitchToLogin).toHaveBeenCalledTimes(1);
  });

  test('shows error when signUp returns an error', async () => {
    mockSignUp.mockResolvedValueOnce({ error: 'network' });

    render(<SignUpPage onSwitchToLogin={onSwitchToLogin} />);

    fireEvent.change(screen.getByLabelText('邮箱地址'), { target: { value: 'test@example.com' } });
    fireEvent.change(screen.getByLabelText('密码'), { target: { value: 'abcdef' } });
    fireEvent.change(screen.getByLabelText('确认密码'), { target: { value: 'abcdef' } });

    fireEvent.click(screen.getByRole('button', { name: /注册/i }));

    const errorAlert = await screen.findByText('注册失败，请重试');
    expect(errorAlert).toBeInTheDocument();

    // Button should be enabled again
    const submitButton = screen.getByRole('button', { name: /注册/i });
    expect(submitButton).toBeEnabled();
  });

  test('calls onSwitchToLogin when clicking "立即登录" link', () => {
    render(<SignUpPage onSwitchToLogin={onSwitchToLogin} />);

    const loginButton = screen.getByRole('button', { name: /立即登录/i });
    fireEvent.click(loginButton);

    expect(onSwitchToLogin).toHaveBeenCalledTimes(1);
  });
});