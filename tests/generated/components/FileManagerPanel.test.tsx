// AUTO-GENERATED BY generate-tests.ts
// Source: src/components/FileManagerPanel.tsx
// DO NOT EDIT MANUALLY - 修改将在下次生成时被覆盖

import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import FileManagerPanel from '../../../src/components/FileManagerPanel';
import { vi, describe, it, expect, beforeEach } from 'vitest';
import '@testing-library/jest-dom';

// Mock external dependencies
vi.mock('../../../src/services/fileService', () => ({
  fileService: {
    getFilesByProject: vi.fn(),
    downloadFile: vi.fn(),
    uploadFile: vi.fn(),
    deleteFile: vi.fn(),
  },
}));

// Mock global functions
const mockOpen = vi.fn();
const mockAlert = vi.fn();
const mockConfirm = vi.fn(() => true);
global.window.open = mockOpen as any;
global.alert = mockAlert as any;
global.confirm = mockConfirm as any;

// Mock fetch for text file content
global.fetch = vi.fn(async (url: string) => ({
  text: async () => 'console.log("test");',
}));

describe('FileManagerPanel', () => {
  const { fileService } = await import('../../../src/services/fileService');

  const mockFiles = [
    {
      id: '1',
      file_name: 'index.html',
      file_path: '/root/index.html',
      file_size: 123,
      mime_type: 'text/html',
    },
    {
      id: '2',
      file_name: 'logo.png',
      file_path: '/root/assets/logo.png',
      file_size: 456,
      mime_type: 'image/png',
    },
    {
      id: '3',
      file_name: 'src/app.tsx',
      file_path: '/root/src/app.tsx',
      file_size: 789,
      mime_type: 'application/typescript',
    },
  ];

  beforeEach(() => {
    vi.clearAllMocks();
    fileService.getFilesByProject.mockResolvedValue({ data: mockFiles, error: undefined });
    fileService.downloadFile.mockImplementation((id: string) => {
      const file = mockFiles.find((f) => f.id === id);
      if (!file) return Promise.resolve({ data: undefined, error: 'not found' });
      // Return a URL string for both image and text files
      return Promise.resolve({ data: `https://example.com/${file.file_name}`, error: undefined });
    });
    fileService.uploadFile.mockResolvedValue({ data: null, error: undefined });
    fileService.deleteFile.mockResolvedValue({ error: undefined });
  });

  it('renders loading state initially', async () => {
    render(<FileManagerPanel projectId="proj-1" />);
    expect(screen.getByText('加载文件中...')).toBeInTheDocument();
    await waitFor(() => expect(screen.queryByText('加载文件中...')).toBeNull());
  });

  it('displays file list after loading', async () => {
    render(<FileManagerPanel projectId="proj-1" />);
    await waitFor(() => expect(screen.getByText('index.html')).toBeInTheDocument());
    expect(screen.getByText('logo.png')).toBeInTheDocument();
    expect(screen.getByText('app.tsx')).toBeInTheDocument();
  });

  it('toggles folder expansion when clicking folder name', async () => {
    render(<FileManagerPanel projectId="proj-1" />);
    await waitFor(() => expect(screen.getByText('src')).toBeInTheDocument());
    const folderToggle = screen.getByText('src');
    fireEvent.click(folderToggle);
    // After expanding, app.tsx should be visible
    expect(screen.getByText('app.tsx')).toBeInTheDocument();
    fireEvent.click(folderToggle);
    // After collapsing, app.tsx should not be visible
    await waitFor(() => expect(screen.queryByText('app.tsx')).toBeNull());
  });

  it('shows text file preview with syntax highlighting', async () => {
    render(<FileManagerPanel projectId="proj-1" />);
    await waitFor(() => expect(screen.getByText('index.html')).toBeInTheDocument());
    fireEvent.click(screen.getByText('index.html'));
    // Wait for content to load
    await waitFor(() => expect(screen.getByText('console.log("test");')).toBeInTheDocument());
    // SyntaxHighlighter component should be present
    expect(screen.getByText('console.log("test");')).toBeInTheDocument();
  });

  it('shows image preview when selecting an image file', async () => {
    render(<FileManagerPanel projectId="proj-1" />);
    await waitFor(() => expect(screen.getByText('logo.png')).toBeInTheDocument());
    fireEvent.click(screen.getByText('logo.png'));
    // Image preview container should be present
    expect(screen.getByRole('img')).toHaveAttribute('src', expect.stringContaining('logo.png'));
  });

  it('toggles uploader panel when clicking upload button', async () => {
    render(<FileManagerPanel projectId="proj-1" />);
    const uploadBtn = screen.getByTitle('上传文件');
    fireEvent.click(uploadBtn);
    expect(screen.getByText('选择文件进行上传')).toBeInTheDocument(); // FileUploader placeholder text
    fireEvent.click(uploadBtn);
    await waitFor(() => expect(screen.queryByText('选择文件进行上传')).toBeNull());
  });

  it('opens create new file dialog and creates file', async () => {
    render(<FileManagerPanel projectId="proj-1" />);
    const newFileBtn = screen.getByTitle('新建文件');
    fireEvent.click(newFileBtn);
    expect(screen.getByText('新建文件')).toBeInTheDocument();

    const nameInput = screen.getByPlaceholderText('例如: index.html, styles.css, script.js');
    const contentTextarea = screen.getByPlaceholderText('在这里输入文件内容...');
    fireEvent.change(nameInput, { target: { value: 'test.txt' } });
    fireEvent.change(contentTextarea, { target: { value: 'Hello World' } });

    const createBtn = screen.getByRole('button', { name: /创建文件/i });
    fireEvent.click(createBtn);

    await waitFor(() => expect(fileService.uploadFile).toHaveBeenCalled());
    // New file should appear in the list
    expect(screen.getByText('test.txt')).toBeInTheDocument();
    // Dialog should close
    await waitFor(() => expect(screen.queryByText('新建文件')).toBeNull());
  });

  it('deletes selected file after confirmation', async () => {
    render(<FileManagerPanel projectId="proj-1" />);
    await waitFor(() => expect(screen.getByText('index.html')).toBeInTheDocument());
    fireEvent.click(screen.getByText('index.html'));
    const deleteBtn = screen.getByTitle('删除');
    fireEvent.click(deleteBtn);
    await waitFor(() => expect(mockConfirm).toHaveBeenCalled());
    await waitFor(() => expect(screen.queryByText('index.html')).toBeNull());
  });

  it('downloads selected file via window.open', async () => {
    render(<FileManagerPanel projectId="proj-1" />);
    await waitFor(() => expect(screen.getByText('logo.png')).toBeInTheDocument());
    fireEvent.click(screen.getByText('logo.png'));
    const downloadBtn = screen.getByTitle('下载');
    fireEvent.click(downloadBtn);
    await waitFor(() => expect(mockOpen).toHaveBeenCalledWith(expect.stringContaining('logo.png'), '_blank'));
  });

  it('filters files based on search query and expands relevant folders', async () => {
    render(<FileManagerPanel projectId="proj-1" />);
    const searchInput = screen.getByPlaceholderText('搜索文件...');
    fireEvent.change(searchInput, { target: { value: 'app' } });
    await waitFor(() => expect(screen.getByText('app.tsx')).toBeInTheDocument());
    expect(screen.queryByText('index.html')).toBeNull();
    // Folder 'src' should be expanded automatically
    const srcFolder = screen.getByText('src');
    expect(srcFolder).toBeInTheDocument();
  });

  it('clears search query when clicking clear button', async () => {
    render(<FileManagerPanel projectId="proj-1" />);
    const searchInput = screen.getByPlaceholderText('搜索文件...');
    fireEvent.change(searchInput, { target: { value: 'index' } });
    await waitFor(() => expect(screen.getByText('index.html')).toBeInTheDocument());
    const clearBtn = screen.getByRole('button', { name: /×/i });
    fireEvent.click(clearBtn);
    await waitFor(() => expect(searchInput).toHaveValue(''));
    // All files should be visible again
    expect(screen.getByText('logo.png')).toBeInTheDocument();
  });
});