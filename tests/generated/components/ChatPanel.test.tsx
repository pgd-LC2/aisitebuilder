// AUTO-GENERATED BY generate-tests.ts
// Source: src/components/ChatPanel.tsx
// DO NOT EDIT MANUALLY - 修改将在下次生成时被覆盖

import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { vi, describe, it, expect, beforeEach, afterEach } from 'vitest';
import ChatPanel from '../../../src/components/ChatPanel';
import { act } from 'react-dom/test-utils';

// Mock external dependencies
vi.mock('../../../src/contexts/ProjectContext', () => ({
  useProject: vi.fn(() => ({
    currentProject: { id: 'proj-123' },
  })),
}));

vi.mock('../../../src/contexts/WorkflowContext', () => ({
  useWorkflow: vi.fn(() => ({
    mode: 'chat',
    isPlanningMode: false,
    isBuildMode: false,
    enterPlanningMode: vi.fn(),
    exitToDefaultMode: vi.fn(),
    planSummary: null,
  })),
}));

vi.mock('../../../src/hooks/useAgentEvents', () => ({
  useAgentEvents: vi.fn(() => ({
    messages: [],
    isConnected: true,
    messageImages: {},
    imageBlobUrls: {},
    appendMessage: vi.fn(),
    refreshMessages: vi.fn(),
  })),
}));

vi.mock('../../../src/services/messageService', () => ({
  messageService: {
    addMessage: vi.fn(() => Promise.resolve({ data: { id: 'msg-1', role: 'user', content: 'test', created_at: new Date().toISOString() }, error: null })),
  },
}));

vi.mock('../../../src/services/buildLogService', () => ({
  buildLogService: {
    addBuildLog: vi.fn(() => Promise.resolve({ data: { id: 'log-1' }, error: null })),
  },
}));

vi.mock('../../../src/services/aiTaskService', () => ({
  aiTaskService: {
    addTask: vi.fn(() => Promise.resolve({ data: { id: 'task-1' }, error: null })),
    triggerProcessor: vi.fn(() => Promise.resolve({ error: null })),
  },
}));

// Mock child components
vi.mock('../../../src/components/BuildLogPanel', () => ({
  default: () => <div data-testid="build-log-panel" />,
}));
vi.mock('../../../src/components/ActivityTimeline', () => ({
  default: () => <div data-testid="activity-timeline" />,
}));
vi.mock('../../../src/components/ImplementationTrigger', () => ({
  default: ({ planSummary, disabled, onImplement }: any) => (
    <button
      data-testid="implementation-trigger"
      disabled={disabled}
      onClick={onImplement}
    >
      Implement
    </button>
  ),
}));

describe('ChatPanel', () => {
  const mockUseProject = vi.importMock('../../../src/contexts/ProjectContext').useProject;
  const mockUseWorkflow = vi.importMock('../../../src/contexts/WorkflowContext').useWorkflow;
  const mockUseAgentEvents = vi.importMock('../../../src/hooks/useAgentEvents').useAgentEvents;
  const mockMessageService = vi.importMock('../../../src/services/messageService').messageService;
  const mockBuildLogService = vi.importMock('../../../src/services/buildLogService').buildLogService;
  const mockAiTaskService = vi.importMock('../../../src/services/aiTaskService').aiTaskService;

  beforeEach(() => {
    vi.clearAllMocks();
  });

  afterEach(() => {
    vi.useRealTimers();
  });

  it('renders loading state when not connected and messages are empty', () => {
    mockUseAgentEvents.mockReturnValue({
      messages: [],
      isConnected: false,
      messageImages: {},
      imageBlobUrls: {},
      appendMessage: vi.fn(),
      refreshMessages: vi.fn(),
    });

    render(<ChatPanel />);
    expect(screen.getByText('加载中...')).toBeInTheDocument();
  });

  it('renders empty conversation message when connected but no messages', () => {
    mockUseAgentEvents.mockReturnValue({
      messages: [],
      isConnected: true,
      messageImages: {},
      imageBlobUrls: {},
      appendMessage: vi.fn(),
      refreshMessages: vi.fn(),
    });

    render(<ChatPanel />);
    expect(screen.getByText('暂无对话')).toBeInTheDocument();
    expect(screen.getByText('输入你的指令开始编辑')).toBeInTheDocument();
  });

  it('renders messages correctly including assistant images', () => {
    mockUseAgentEvents.mockReturnValue({
      messages: [
        { id: 'msg-1', role: 'user', content: 'Hello', created_at: new Date().toISOString() },
        { id: 'msg-2', role: 'assistant', content: 'Hi there', created_at: new Date().toISOString() },
      ],
      isConnected: true,
      messageImages: {
        'msg-2': ['image1.png'],
      },
      imageBlobUrls: {
        'image1.png': 'data:image/png;base64,...',
      },
      appendMessage: vi.fn(),
      refreshMessages: vi.fn(),
    });

    render(<ChatPanel />);
    expect(screen.getByText('Hello')).toBeInTheDocument();
    expect(screen.getByText('Hi there')).toBeInTheDocument();
    expect(screen.getByAltText('生成的图片 1')).toBeInTheDocument();
  });

  it('sends message on button click and clears input', async () => {
    const mockAppendMessage = vi.fn();
    mockUseAgentEvents.mockReturnValue({
      messages: [],
      isConnected: true,
      messageImages: {},
      imageBlobUrls: {},
      appendMessage: mockAppendMessage,
      refreshMessages: vi.fn(),
    });

    render(<ChatPanel />);
    const textarea = screen.getByRole('textbox') as HTMLTextAreaElement;
    fireEvent.change(textarea, { target: { value: 'Test message' } });
    expect(textarea.value).toBe('Test message');

    const sendButton = screen.getByRole('button', { name: '' }) as HTMLButtonElement;
    fireEvent.click(sendButton);

    await waitFor(() => {
      expect(mockMessageService.addMessage).toHaveBeenCalledWith('proj-123', 'user', 'Test message');
      expect(mockAppendMessage).toHaveBeenCalled();
      expect(textarea.value).toBe('');
    });
  });

  it('triggers send on Enter key press without Shift', async () => {
    const mockAppendMessage = vi.fn();
    mockUseAgentEvents.mockReturnValue({
      messages: [],
      isConnected: true,
      messageImages: {},
      imageBlobUrls: {},
      appendMessage: mockAppendMessage,
      refreshMessages: vi.fn(),
    });

    render(<ChatPanel />);
    const textarea = screen.getByRole('textbox') as HTMLTextAreaElement;
    fireEvent.change(textarea, { target: { value: 'Enter test' } });

    fireEvent.keyDown(textarea, { key: 'Enter', code: 'Enter', shiftKey: false });

    await waitFor(() => {
      expect(mockMessageService.addMessage).toHaveBeenCalledWith('proj-123', 'user', 'Enter test');
      expect(mockAppendMessage).toHaveBeenCalled();
    });
  });

  it('does not send message when input is empty or whitespace', async () => {
    const mockAppendMessage = vi.fn();
    mockUseAgentEvents.mockReturnValue({
      messages: [],
      isConnected: true,
      messageImages: {},
      imageBlobUrls: {},
      appendMessage: mockAppendMessage,
      refreshMessages: vi.fn(),
    });

    render(<ChatPanel />);
    const textarea = screen.getByRole('textbox') as HTMLTextAreaElement;
    fireEvent.change(textarea, { target: { value: '   ' } });

    const sendButton = screen.getByRole('button', { name: '' }) as HTMLButtonElement;
    fireEvent.click(sendButton);

    await waitFor(() => {
      expect(mockMessageService.addMessage).not.toHaveBeenCalled();
      expect(mockAppendMessage).not.toHaveBeenCalled();
    });
  });

  it('shows planning mode banner and exit button works', () => {
    mockUseWorkflow.mockReturnValue({
      mode: 'chat',
      isPlanningMode: true,
      isBuildMode: false,
      enterPlanningMode: vi.fn(),
      exitToDefaultMode: vi.fn(),
      planSummary: null,
    });

    render(<ChatPanel />);
    expect(screen.getByText('规划模式')).toBeInTheDocument();
    const exitButton = screen.getByRole('button', { name: '' }) as HTMLButtonElement;
    fireEvent.click(exitButton);
    expect(mockUseWorkflow().exitToDefaultMode).toHaveBeenCalled();
  });

  it('shows build mode banner and exit button works', () => {
    mockUseWorkflow.mockReturnValue({
      mode: 'chat',
      isPlanningMode: false,
      isBuildMode: true,
      enterPlanningMode: vi.fn(),
      exitToDefaultMode: vi.fn(),
      planSummary: null,
    });

    render(<ChatPanel />);
    expect(screen.getByText('构建模式')).toBeInTheDocument();
    const exitButton = screen.getByRole('button', { name: '' }) as HTMLButtonElement;
    fireEvent.click(exitButton);
    expect(mockUseWorkflow().exitToDefaultMode).toHaveBeenCalled();
  });

  it('renders ImplementationTrigger when planSummary is present and clicking triggers implement', async () => {
    const planSummary = {
      requirement: 'Requirement',
      technicalPlan: 'Tech plan',
      implementationSteps: ['step1'],
    };
    mockUseWorkflow.mockReturnValue({
      mode: 'chat',
      isPlanningMode: false,
      isBuildMode: false,
      enterPlanningMode: vi.fn(),
      exitToDefaultMode: vi.fn(),
      planSummary,
    });

    const mockAppendMessage = vi.fn();
    const mockRefreshMessages = vi.fn();
    mockUseAgentEvents.mockReturnValue({
      messages: [
        {
          id: 'msg-1',
          role: 'assistant',
          content: `[IMPLEMENT_READY]${JSON.stringify(planSummary)}[/IMPLEMENT_READY]`,
          created_at: new Date().toISOString(),
        },
      ],
      isConnected: true,
      messageImages: {},
      imageBlobUrls: {},
      appendMessage: mockAppendMessage,
      refreshMessages: mockRefreshMessages,
    });

    render(<ChatPanel />);
    const triggerButton = screen.getByTestId('implementation-trigger');
    expect(triggerButton).toBeInTheDocument();
    expect(triggerButton).not.toBeDisabled();

    vi.useFakeTimers();
    fireEvent.click(triggerButton);
    await waitFor(() => {
      expect(mockMessageService.addMessage).toHaveBeenCalledWith(
        'proj-123',
        'user',
        "Great, let's implement this plan together!"
      );
    });
    vi.runAllTimers();
  });

  it('does not render ImplementationTrigger if not latest message', () => {
    const planSummary = {
      requirement: 'Requirement',
      technicalPlan: 'Tech plan',
      implementationSteps: ['step1'],
    };
    mockUseWorkflow.mockReturnValue({
      mode: 'chat',
      isPlanningMode: false,
      isBuildMode: false,
      enterPlanningMode: vi.fn(),
      exitToDefaultMode: vi.fn(),
      planSummary,
    });

    mockUseAgentEvents.mockReturnValue({
      messages: [
        {
          id: 'msg-1',
          role: 'assistant',
          content: `[IMPLEMENT_READY]${JSON.stringify(planSummary)}[/IMPLEMENT_READY]`,
          created_at: new Date().toISOString(),
        },
        {
          id: 'msg-2',
          role: 'user',
          content: 'User message',
          created_at: new Date().toISOString(),
        },
      ],
      isConnected: true,
      messageImages: {},
      imageBlobUrls: {},
      appendMessage: vi.fn(),
      refreshMessages: vi.fn(),
    });

    render(<ChatPanel />);
    const triggerButton = screen.queryByTestId('implementation-trigger');
    expect(triggerButton).toBeNull();
  });
});