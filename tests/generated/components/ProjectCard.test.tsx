// AUTO-GENERATED BY generate-tests.ts
// Source: src/components/ProjectCard.tsx
// DO NOT EDIT MANUALLY - 修改将在下次生成时被覆盖

import { render, screen, fireEvent } from '@testing-library/react';
import { vi, describe, it, expect, test } from 'vitest';
import ProjectCard from '../../../src/components/ProjectCard';
import { Project } from '../../../src/types/project';

vi.mock('lucide-react', () => ({
  Clock: () => <svg data-testid="clock" />,
  MoreVertical: () => <svg data-testid="more-vertical" />,
  Trash2: () => <svg data-testid="trash-2" />,
}));

describe('ProjectCard', () => {
  const baseProject: Project = {
    id: '1',
    title: 'Test Project',
    description: 'A short description.',
    status: 'draft',
    created_at: '2023-01-01T00:00:00Z',
  };

  it('renders correctly without onDelete prop', () => {
    const onClick = vi.fn();
    render(<ProjectCard project={baseProject} onClick={onClick} />);

    expect(screen.getByText(baseProject.title)).toBeInTheDocument();
    expect(screen.getByText(baseProject.description)).toBeInTheDocument();
    expect(screen.getByText('草稿')).toBeInTheDocument();
    expect(screen.queryByTestId('more-vertical')).toBeNull();
  });

  it('renders menu button when onDelete prop is provided', () => {
    const onClick = vi.fn();
    const onDelete = vi.fn();
    render(
      <ProjectCard project={baseProject} onClick={onClick} onDelete={onDelete} />
    );

    const menuButton = screen.getByTestId('more-vertical');
    expect(menuButton).toBeInTheDocument();
  });

  it('calls onClick when card is clicked', () => {
    const onClick = vi.fn();
    render(<ProjectCard project={baseProject} onClick={onClick} />);
    const card = screen.getByRole('button', { name: '' }) || screen.getByText(baseProject.title).closest('div')!;
    fireEvent.click(card);
    expect(onClick).toHaveBeenCalledTimes(1);
  });

  it('toggles menu visibility when menu button is clicked', () => {
    const onClick = vi.fn();
    const onDelete = vi.fn();
    render(
      <ProjectCard project={baseProject} onClick={onClick} onDelete={onDelete} />
    );

    const menuButton = screen.getByTestId('more-vertical');
    fireEvent.click(menuButton);
    expect(screen.getByText('删除项目')).toBeInTheDocument();

    fireEvent.click(menuButton);
    expect(screen.queryByText('删除项目')).toBeNull();
  });

  it('calls onDelete and hides menu when delete button is clicked', () => {
    const onClick = vi.fn();
    const onDelete = vi.fn();
    render(
      <ProjectCard project={baseProject} onClick={onClick} onDelete={onDelete} />
    );

    const menuButton = screen.getByTestId('more-vertical');
    fireEvent.click(menuButton);
    const deleteButton = screen.getByText('删除项目');
    fireEvent.click(deleteButton);
    expect(onDelete).toHaveBeenCalledTimes(1);
    expect(screen.queryByText('删除项目')).toBeNull();
  });

  it('hides menu when clicking outside', () => {
    const onClick = vi.fn();
    const onDelete = vi.fn();
    render(
      <ProjectCard project={baseProject} onClick={onClick} onDelete={onDelete} />
    );

    const menuButton = screen.getByTestId('more-vertical');
    fireEvent.click(menuButton);
    expect(screen.getByText('删除项目')).toBeInTheDocument();

    fireEvent.mouseDown(document);
    expect(screen.queryByText('删除项目')).toBeNull();
  });

  test.each([
    ['draft', '草稿', 'bg-gray-100 text-gray-700'],
    ['building', '构建中', 'bg-blue-100 text-blue-700'],
    ['completed', '已完成', 'bg-green-100 text-green-700'],
    ['failed', '失败', 'bg-red-100 text-red-700'],
  ])('renders correct status label and class for %s status', (status, label, className) => {
    const project: Project = { ...baseProject, status };
    render(<ProjectCard project={project} onClick={vi.fn()} />);
    const statusSpan = screen.getByText(label);
    expect(statusSpan).toBeInTheDocument();
    expect(statusSpan).toHaveClass(...className.split(' '));
  });

  describe('formatDate utility', () => {
    vi.useFakeTimers('modern');
    const now = new Date('2023-01-01T12:00:00Z');
    vi.setSystemTime(now);

    test.each([
      ['2023-01-01T11:59:00Z', '1 分钟前'],
      ['2023-01-01T11:00:00Z', '60 分钟前'],
      ['2023-01-01T10:00:00Z', '2 小时前'],
      ['2023-01-01T00:00:00Z', '12 小时前'],
      ['2022-12-31T12:00:00Z', '1 天前'],
      ['2022-12-25T12:00:00Z', '7 天前'],
      ['2022-12-20T12:00:00Z', '12-20'],
    ])('displays %s for created_at %s', (createdAt, expected) => {
      const project: Project = { ...baseProject, created_at: createdAt };
      render(<ProjectCard project={project} onClick={vi.fn()} />);
      expect(screen.getByText(expected)).toBeInTheDocument();
    });
  });

  describe('truncateDescription utility', () => {
    it('does not truncate short description', () => {
      const project: Project = { ...baseProject, description: 'Short desc' };
      render(<ProjectCard project={project} onClick={vi.fn()} />);
      expect(screen.getByText('Short desc')).toBeInTheDocument();
    });

    it('truncates long description with ellipsis', () => {
      const longDesc = 'a'.repeat(90);
      const truncated = `${longDesc.slice(0, 80)}...`;
      const project: Project = { ...baseProject, description: longDesc };
      render(<ProjectCard project={project} onClick={vi.fn()} />);
      expect(screen.getByText(truncated)).toBeInTheDocument();
    });
  });
});