// AUTO-GENERATED BY generate-tests.ts
// Source: src/components/CodeViewer.tsx
// DO NOT EDIT MANUALLY - ä¿®æ”¹å°†åœ¨ä¸‹æ¬¡ç”Ÿæˆæ—¶è¢«è¦†ç›–

import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import CodeViewer from '../../../src/components/CodeViewer';
import { X, Copy, Check } from 'lucide-react';

vi.mock('lucide-react', () => ({
  X: () => <svg data-testid="icon-x" />,
  Copy: () => <svg data-testid="icon-copy" />,
  Check: () => <svg data-testid="icon-check" />,
}));

beforeEach(() => {
  // Reset global mocks
  vi.restoreAllMocks();
  // Mock Prism globally
  (window as any).Prism = {
    highlight: vi.fn((code: string, _: any, __: string) => `<span>${code}</span>`),
    languages: {
      javascript: {},
      typescript: {},
      jsx: {},
      tsx: {},
      css: {},
      html: {},
      json: {},
      python: {},
      java: {},
      go: {},
      rust: {},
      plaintext: {},
    },
  };
  // Mock clipboard
  Object.defineProperty(navigator, 'clipboard', {
    value: {
      writeText: vi.fn().mockResolvedValue(undefined),
    },
    writable: true,
  });
});

describe('CodeViewer', () => {
  const codeSample = `const a = 1;\nconsole.log(a);`;
  const filename = 'example.ts';
  const language = 'typescript';
  const onClose = vi.fn();

  it('renders filename, language display, and line count correctly', async () => {
    render(
      <CodeViewer
        code={codeSample}
        language={language}
        filename={filename}
        onClose={onClose}
      />
    );

    expect(screen.getByText(filename)).toBeInTheDocument();
    expect(screen.getByText('TypeScript')).toBeInTheDocument();
    expect(screen.getByText(`${codeSample.split('\n').length} è¡Œ`)).toBeInTheDocument();

    // Wait for Prism highlighting to complete
    await waitFor(() => {
      expect((window as any).Prism.highlight).toHaveBeenCalled();
    });
  });

  it('copy button writes to clipboard and shows copied state', async () => {
    render(
      <CodeViewer
        code={codeSample}
        language={language}
        filename={filename}
        onClose={onClose}
      />
    );

    const copyButton = screen.getByRole('button', { name: /å¤åˆ¶ä»£ç /i });
    fireEvent.click(copyButton);

    await waitFor(() => {
      expect(navigator.clipboard.writeText).toHaveBeenCalledWith(codeSample);
    });

    // Copied state
    expect(screen.getByText('å·²å¤åˆ¶')).toBeInTheDocument();
    expect(screen.getByTestId('icon-check')).toBeInTheDocument();

    // Fast-forward 2 seconds
    vi.useFakeTimers();
    vi.advanceTimersByTime(2000);
    vi.useRealTimers();

    // Should revert to original copy text
    expect(screen.getByText('å¤åˆ¶ä»£ç ')).toBeInTheDocument();
    expect(screen.queryByText('å·²å¤åˆ¶')).not.toBeInTheDocument();
  });

  it('close button triggers onClose callback', async () => {
    render(
      <CodeViewer
        code={codeSample}
        language={language}
        filename={filename}
        onClose={onClose}
      />
    );

    const closeButton = screen.getByRole('button', { name: '' });
    fireEvent.click(closeButton);
    expect(onClose).toHaveBeenCalledTimes(1);
  });

  it.each`
    langProp      | expectedDisplay
    ${'javascript'}| ${'JavaScript'}
    ${'typescript'}| ${'TypeScript'}
    ${'jsx'}       | ${'JSX'}
    ${'tsx'}       | ${'TSX'}
    ${'css'}       | ${'CSS'}
    ${'html'}       | ${'HTML'}
    ${'json'}       | ${'JSON'}
    ${'python'}     | ${'Python'}
    ${'java'}       | ${'Java'}
    ${'go'}         | ${'Go'}
    ${'rust'}       | ${'Rust'}
    ${'markdown'}   | ${'Markdown'}
    ${'unknown'}    | ${'UNKNOWN'}
  `('displays correct language display for $langProp', async ({ langProp, expectedDisplay }) => {
    render(
      <CodeViewer
        code={codeSample}
        language={langProp}
        filename={filename}
        onClose={onClose}
      />
    );

    expect(screen.getByText(expectedDisplay)).toBeInTheDocument();
  });

  it('handles empty code and line count correctly', async () => {
    render(
      <CodeViewer
        code={''}
        language={language}
        filename={filename}
        onClose={onClose}
      />
    );

    expect(screen.getByText('1 è¡Œ')).toBeInTheDocument();
  });

  it('renders code with special characters without breaking', async () => {
    const specialCode = `const s = "Hello, ä¸–ç•Œ! ðŸ˜Š";\nconsole.log(s);`;
    render(
      <CodeViewer
        code={specialCode}
        language={language}
        filename={filename}
        onClose={onClose}
      />
    );

    await waitFor(() => {
      expect((window as any).Prism.highlight).toHaveBeenCalled();
    });

    const codeElement = screen.getByText((content, element) => {
      return element?.tagName.toLowerCase() === 'code' && content.includes(specialCode);
    });
    expect(codeElement).toBeInTheDocument();
  });
});