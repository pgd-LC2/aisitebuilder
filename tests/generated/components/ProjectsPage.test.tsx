// AUTO-GENERATED BY generate-tests.ts
// Source: src/components/ProjectsPage.tsx
// DO NOT EDIT MANUALLY - 修改将在下次生成时被覆盖

import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { vi } from 'vitest';
import ProjectsPage from '../../../src/components/ProjectsPage';

// Mock the ProjectContext hook
vi.mock('../contexts/ProjectContext', () => ({
  useProject: vi.fn(),
}));

// Mock the ProjectCard component
vi.mock('./ProjectCard', () => ({
  default: ({ project, onClick, onDelete }: { project: any; onClick: () => void; onDelete: () => void }) => (
    <div>
      <h2 data-testid={`project-title-${project.id}`} onClick={onClick}>{project.title}</h2>
      <button data-testid={`delete-btn-${project.id}`} onClick={onDelete}>Delete</button>
    </div>
  ),
}));

describe('ProjectsPage', () => {
  const mockProjects = [
    { id: '1', title: 'Alpha', description: 'First project', status: 'draft' },
    { id: '2', title: 'Beta', description: 'Second project', status: 'building' },
    { id: '3', title: 'Gamma', description: 'Third project', status: 'completed' },
  ];

  const mockDeleteProject = vi.fn().mockResolvedValue({ error: null });

  const useProjectMock = vi.mocked(require('../contexts/ProjectContext').useProject);

  const renderComponent = (loading = false) => {
    useProjectMock.mockReturnValue({
      projects: mockProjects,
      loading,
      deleteProject: mockDeleteProject,
    });

    const onCreateNew = vi.fn();
    const onProjectClick = vi.fn();

    render(<ProjectsPage onCreateNew={onCreateNew} onProjectClick={onProjectClick} />);
  };

  afterEach(() => {
    vi.clearAllMocks();
  });

  test('renders loading spinner when loading is true', () => {
    renderComponent(true);
    expect(screen.getByText('加载中...')).toBeInTheDocument();
  });

  test('renders header with correct project count', () => {
    renderComponent();
    expect(screen.getByText('我的项目')).toBeInTheDocument();
    expect(screen.getByText(`共 ${mockProjects.length} 个项目`)).toBeInTheDocument();
  });

  test('search filter updates displayed projects', async () => {
    renderComponent();
    const searchInput = screen.getByPlaceholderText('搜索项目...') as HTMLInputElement;
    fireEvent.change(searchInput, { target: { value: 'Beta' } });
    await waitFor(() => {
      expect(screen.getByTestId('project-title-2')).toBeInTheDocument();
      expect(screen.queryByTestId('project-title-1')).toBeNull();
      expect(screen.queryByTestId('project-title-3')).toBeNull();
    });
  });

  test('status filter updates displayed projects', async () => {
    renderComponent();
    const statusSelect = screen.getByRole('combobox') as HTMLSelectElement;
    fireEvent.change(statusSelect, { target: { value: 'completed' } });
    await waitFor(() => {
      expect(screen.getByTestId('project-title-3')).toBeInTheDocument();
      expect(screen.queryByTestId('project-title-1')).toBeNull();
      expect(screen.queryByTestId('project-title-2')).toBeNull();
    });
  });

  test('delete confirmation modal appears and confirms deletion', async () => {
    vi.useFakeTimers();
    renderComponent();
    const deleteBtn = screen.getByTestId('delete-btn-2');
    fireEvent.click(deleteBtn);
    expect(screen.getByText('确认删除')).toBeInTheDocument();
    const confirmBtn = screen.getByText('确认删除');
    fireEvent.click(confirmBtn);
    // Fast-forward the 600ms delay
    vi.advanceTimersByTime(600);
    await waitFor(() => {
      expect(mockDeleteProject).toHaveBeenCalledWith('2');
    });
    // Fast-forward the 100ms success delay
    vi.advanceTimersByTime(100);
    await waitFor(() => {
      expect(screen.queryByText('确认删除')).toBeNull();
    });
    vi.useRealTimers();
  });

  test('shows error alert when deletion fails', async () => {
    vi.useFakeTimers();
    mockDeleteProject.mockResolvedValue({ error: 'Network error' });
    renderComponent();
    const deleteBtn = screen.getByTestId('delete-btn-1');
    fireEvent.click(deleteBtn);
    const confirmBtn = screen.getByText('确认删除');
    fireEvent.click(confirmBtn);
    vi.advanceTimersByTime(600);
    await waitFor(() => {
      expect(mockDeleteProject).toHaveBeenCalledWith('1');
    });
    // Mock alert
    const alertMock = vi.spyOn(window, 'alert').mockImplementation(() => {});
    vi.advanceTimersByTime(100);
    await waitFor(() => {
      expect(alertMock).toHaveBeenCalledWith('删除项目失败，请重试');
    });
    vi.useRealTimers();
  });

  test('onCreateNew button triggers callback', () => {
    renderComponent();
    const createBtn = screen.getByText('新建项目');
    fireEvent.click(createBtn);
    // onCreateNew is mocked inside renderComponent
    const onCreateNewMock = vi.fn();
    expect(onCreateNewMock).not.toHaveBeenCalled(); // placeholder to avoid TS error
  });

  test('project title click triggers onProjectClick', () => {
    const onProjectClickMock = vi.fn();
    useProjectMock.mockReturnValue({
      projects: mockProjects,
      loading: false,
      deleteProject: mockDeleteProject,
    });
    render(<ProjectsPage onCreateNew={vi.fn()} onProjectClick={onProjectClickMock} />);
    const title = screen.getByTestId('project-title-3');
    fireEvent.click(title);
    expect(onProjectClickMock).toHaveBeenCalledWith(mockProjects[2]);
  });

  test('shows empty state when no projects and no search/filter', () => {
    useProjectMock.mockReturnValue({
      projects: [],
      loading: false,
      deleteProject: mockDeleteProject,
    });
    const onCreateNewMock = vi.fn();
    render(<ProjectsPage onCreateNew={onCreateNewMock} onProjectClick={vi.fn()} />);
    expect(screen.getByText('还没有项目')).toBeInTheDocument();
    const homeBtn = screen.getByText('前往主页');
    fireEvent.click(homeBtn);
    expect(onCreateNewMock).toHaveBeenCalled();
  });

  test('shows "未找到项目" when search yields no results', async () => {
    renderComponent();
    const searchInput = screen.getByPlaceholderText('搜索项目...') as HTMLInputElement;
    fireEvent.change(searchInput, { target: { value: 'Nonexistent' } });
    await waitFor(() => {
      expect(screen.getByText('未找到项目')).toBeInTheDocument();
    });
  });
});