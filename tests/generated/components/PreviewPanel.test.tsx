// AUTO-GENERATED BY generate-tests.ts
// Source: src/components/PreviewPanel.tsx
// DO NOT EDIT MANUALLY - 修改将在下次生成时被覆盖

import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { vi, describe, it, expect, beforeEach } from 'vitest';
import PreviewPanel from '../../../src/components/PreviewPanel';
import { ProjectFile } from '../../../src/types/project';
import { useProject } from '../../../src/contexts/ProjectContext';
import { useSettings } from '../../../src/contexts/SettingsContext';
import { fileService } from '../../../src/services/fileService';
import { webContainerManager } from '../../../src/lib/webContainerManager';
import {
  clearNodeModulesCache,
  loadNodeModulesSnapshot,
  saveNodeModulesSnapshot,
} from '../../../src/lib/nodeModulesCache';
import FileManagerPanel from '../../../src/components/FileManagerPanel';

// Mock external modules
vi.mock('../../../src/contexts/ProjectContext', () => ({
  useProject: vi.fn(),
}));
vi.mock('../../../src/contexts/SettingsContext', () => ({
  useSettings: vi.fn(),
}));
vi.mock('../../../src/services/fileService', () => ({
  fileService: {
    downloadFile: vi.fn(),
    getFilesByProject: vi.fn(),
  },
}));
vi.mock('../../../src/lib/webContainerManager', () => ({
  webContainerManager: {
    isSupported: vi.fn(),
    getUnsupportedReason: vi.fn(),
    loadWebContainerClass: vi.fn(),
    boot: vi.fn(),
    teardown: vi.fn(),
    getInstance: vi.fn(),
    getDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
    setDevServerProcess: vi.fn(),
  },
}));
vi.mock('../../../src/lib/nodeModulesCache', () => ({
  clearNodeModulesCache: vi.fn(),
  loadNodeModulesSnapshot: vi.fn(),
  saveNodeModulesSnapshot: vi.fn(),
}));
vi.mock('../../../src/components/FileManagerPanel', () => ({
  default: () => <div>File Manager Panel</div>,
}));

describe('PreviewPanel', () => {
  const dummyProject = { id: 'proj-1', title: 'Test Project' };
  const dummyFiles: ProjectFile[] = [
    { id: '1', file_path: 'src/index.ts', file_name: 'index.ts', mime_type: 'text/plain' },
    { id: '2', file_path: 'package.json', file_name: 'package.json', mime_type: 'application/json' },
  ];

  beforeEach(() => {
    vi.clearAllMocks();
    (useProject as vi.Mock).mockReturnValue({ currentProject: dummyProject });
    (useSettings as vi.Mock).mockReturnValue({ preloadNodeModules: false });
    (fileService.getFilesByProject as vi.Mock).mockResolvedValue({ data: dummyFiles, error: null });
    (webContainerManager.isSupported as vi.Mock).mockReturnValue(true);
    (webContainerManager.loadWebContainerClass as vi.Mock).mockResolvedValue(true);
    (webContainerManager.boot as vi.Mock).mockResolvedValue({
      fs: {
        readdir: vi.fn().mockResolvedValue([]),
        mkdir: vi.fn().mockResolvedValue(undefined),
        writeFile: vi.fn().mockResolvedValue(undefined),
        rm: vi.fn().mockResolvedValue(undefined),
      },
      spawn: vi.fn().mockResolvedValue({
        output: {
          pipeTo: vi.fn(),
        },
        exit: Promise.resolve(0),
      }),
      on: vi.fn(),
    });
  });

  it('renders preview panel with default state', async () => {
    render(<PreviewPanel currentVersionId="v1" />);
    // Wait for async effects to settle
    await waitFor(() => {
      expect(screen.getByText('等待开始')).toBeInTheDocument();
    });

    // Preview button should be active
    const previewBtn = screen.getByRole('button', { name: /预览/i });
    expect(previewBtn).toHaveClass('bg-white text-gray-900');

    // File button should be inactive
    const filesBtn = screen.getByRole('button', { name: /文件/i });
    expect(filesBtn).not.toHaveClass('bg-white text-gray-900');
  });

  it('switches to files panel when clicking 文件 button', async () => {
    render(<PreviewPanel currentVersionId="v1" />);
    const filesBtn = screen.getByRole('button', { name: /文件/i });
    fireEvent.click(filesBtn);

    // FileManagerPanel should be rendered
    expect(await screen.findByText('File Manager Panel')).toBeInTheDocument();

    // Preview loading screen should not be visible
    expect(screen.queryByText('等待开始')).not.toBeInTheDocument();
  });

  it('updates viewport mode when clicking tablet button', async () => {
    render(<PreviewPanel currentVersionId="v1" />);
    const tabletBtn = screen.getByRole('button', { name: /平板视图/i });
    fireEvent.click(tabletBtn);

    // Tablet button should now have active style
    expect(tabletBtn).toHaveClass('bg-white text-gray-900');
  });

  it('disables reload button when preview status is unsupported', async () => {
    (webContainerManager.isSupported as vi.Mock).mockReturnValue(false);
    render(<PreviewPanel currentVersionId="v1" />);

    await waitFor(() => {
      expect(screen.getByText('环境不支持')).toBeInTheDocument();
    });

    const reloadBtn = screen.getByRole('button', { name: /重新加载预览画面/i });
    expect(reloadBtn).toBeDisabled();
  });

  it('resets to idle status when currentProject becomes null', async () => {
    (useProject as vi.Mock).mockReturnValue({ currentProject: null });
    render(<PreviewPanel currentVersionId="v1" />);

    await waitFor(() => {
      expect(screen.getByText('等待开始')).toBeInTheDocument();
    });
  });
});