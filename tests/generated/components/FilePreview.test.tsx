// AUTO-GENERATED BY generate-tests.ts
// Source: src/components/FilePreview.tsx
// DO NOT EDIT MANUALLY - 修改将在下次生成时被覆盖

import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import FilePreview from '../../../src/components/FilePreview';
import { ProjectFile } from '../../../src/types/project';
import { fileService } from '../../../src/services/fileService';

vi.mock('../../../src/services/fileService', () => ({
  fileService: {
    downloadFile: vi.fn(),
    generateShareLink: vi.fn(),
    formatFileSize: vi.fn().mockReturnValue('1 MB'),
    getFileIcon: vi.fn().mockReturnValue(<svg data-testid="file-icon" />),
  },
}));

// Mock global APIs
const mockWindowOpen = vi.fn();
const mockAlert = vi.fn();
const mockConfirm = vi.fn().mockReturnValue(true);
const mockClipboardWrite = vi.fn();

global.window.open = mockWindowOpen as any;
global.alert = mockAlert as any;
global.confirm = mockConfirm as any;
global.navigator.clipboard = {
  writeText: mockClipboardWrite,
} as any;

describe('FilePreview component', () => {
  const baseFile: ProjectFile = {
    id: 'file-123',
    file_name: 'test.txt',
    mime_type: 'text/plain',
    file_size: 1024,
  };

  beforeEach(() => {
    vi.clearAllMocks();
  });

  afterEach(() => {
    // Ensure that any pending timers are cleared
    vi.useRealTimers();
  });

  const renderComponent = (file: ProjectFile, onClose = vi.fn(), onDelete = vi.fn()) => {
    render(
      <FilePreview file={file} onClose={onClose} onDelete={onDelete} />
    );
    return { onClose, onDelete };
  };

  // 1. Rendering and basic UI
  it('renders file name and size correctly', () => {
    renderComponent(baseFile);
    expect(screen.getByText('test.txt')).toBeInTheDocument();
    expect(screen.getByText('1 MB · text/plain')).toBeInTheDocument();
  });

  // 2. Image preview flow
  it('loads and displays image preview when file is an image', async () => {
    const imageFile: ProjectFile = { ...baseFile, mime_type: 'image/jpeg', file_name: 'photo.jpg' };
    (fileService.downloadFile as vi.Mock).mockResolvedValue({ data: 'http://example.com/photo.jpg', error: null });

    renderComponent(imageFile);

    // Initially loading indicator should be present
    expect(screen.getByText('加载中...')).toBeInTheDocument();

    // Wait for preview to load
    await waitFor(() => {
      expect(screen.queryByText('加载中...')).not.toBeInTheDocument();
    });

    // Image element should appear
    const img = screen.getByRole('img', { name: 'photo.jpg' }) as HTMLImageElement;
    expect(img).toBeInTheDocument();
    expect(img.src).toBe('http://example.com/photo.jpg');
  });

  // 3. PDF preview flow
  it('loads and displays PDF preview when file is a PDF', async () => {
    const pdfFile: ProjectFile = { ...baseFile, mime_type: 'application/pdf', file_name: 'doc.pdf' };
    (fileService.downloadFile as vi.Mock).mockResolvedValue({ data: 'http://example.com/doc.pdf', error: null });

    renderComponent(pdfFile);

    expect(screen.getByText('加载中...')).toBeInTheDocument();

    await waitFor(() => {
      expect(screen.queryByText('加载中...')).not.toBeInTheDocument();
    });

    const iframe = screen.getByTitle('doc.pdf') as HTMLIFrameElement;
    expect(iframe).toBeInTheDocument();
    expect(iframe.src).toBe('http://example.com/doc.pdf');
  });

  // 4. Non-image/PDF preview fallback
  it('shows fallback UI for unsupported file types', () => {
    renderComponent(baseFile);

    // No loading indicator
    expect(screen.queryByText('加载中...')).not.toBeInTheDocument();

    // Icon should be rendered
    expect(screen.getByTestId('file-icon')).toBeInTheDocument();

    // Message
    expect(screen.getByText('此文件类型暂不支持预览')).toBeInTheDocument();

    // Download button in fallback UI
    const fallbackButton = screen.getByRole('button', { name: '下载文件' });
    expect(fallbackButton).toBeInTheDocument();
  });

  // 5. Download button behavior
  it('downloads file and opens new window on download button click', async () => {
    const downloadUrl = 'http://example.com/file.txt';
    (fileService.downloadFile as vi.Mock).mockResolvedValue({ data: downloadUrl, error: null });

    renderComponent(baseFile);

    const downloadBtn = screen.getByRole('button', { name: /下载/i });
    fireEvent.click(downloadBtn);

    await waitFor(() => {
      expect(fileService.downloadFile).toHaveBeenCalledWith('file-123');
      expect(mockWindowOpen).toHaveBeenCalledWith(downloadUrl, '_blank');
    });
  });

  // 6. Share button behavior
  it('generates share link, copies to clipboard and shows alert', async () => {
    const shareLink = { url: 'http://example.com/share' };
    (fileService.generateShareLink as vi.Mock).mockResolvedValue({ data: shareLink, error: null });

    renderComponent(baseFile);

    const shareBtn = screen.getByRole('button', { name: /分享/i });
    fireEvent.click(shareBtn);

    await waitFor(() => {
      expect(fileService.generateShareLink).toHaveBeenCalledWith('file-123', 604800);
      expect(mockClipboardWrite).toHaveBeenCalledWith(shareLink.url);
      expect(mockAlert).toHaveBeenCalledWith('分享链接已复制到剪贴板');
    });

    // Share URL section should appear
    expect(screen.getByDisplayValue(shareLink.url)).toBeInTheDocument();
  });

  // 7. Delete button behavior
  it('calls onDelete when delete is confirmed', () => {
    const onDeleteMock = vi.fn();
    renderComponent(baseFile, vi.fn(), onDeleteMock);

    const deleteBtn = screen.getByRole('button', { name: /删除/i });
    fireEvent.click(deleteBtn);

    expect(mockConfirm).toHaveBeenCalledWith('确定要删除文件 "test.txt" 吗？');
    expect(onDeleteMock).toHaveBeenCalledWith('file-123');
  });

  // 8. Delete button not shown when onDelete not provided
  it('does not render delete button if onDelete prop is omitted', () => {
    renderComponent(baseFile, vi.fn(), undefined);
    expect(screen.queryByRole('button', { name: /删除/i })).toBeNull();
  });

  // 9. Close button behavior
  it('calls onClose when close button is clicked', () => {
    const onCloseMock = vi.fn();
    renderComponent(baseFile, onCloseMock, vi.fn());

    const closeBtn = screen.getByRole('button', { name: /关闭/i });
    fireEvent.click(closeBtn);

    expect(onCloseMock).toHaveBeenCalled();
  });

  // 10. Disabled state during loading
  it('disables download and share buttons while loading', async () => {
    const pendingPromise = new Promise(() => {}); // never resolves
    (fileService.downloadFile as vi.Mock).mockReturnValue(pendingPromise);
    (fileService.generateShareLink as vi.Mock).mockReturnValue(pendingPromise);

    renderComponent(baseFile);

    const downloadBtn = screen.getByRole('button', { name: /下载/i });
    const shareBtn = screen.getByRole('button', { name: /分享/i });

    expect(downloadBtn).toBeDisabled();
    expect(shareBtn).toBeDisabled();
  });
});