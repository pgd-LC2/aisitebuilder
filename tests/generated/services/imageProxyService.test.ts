// AUTO-GENERATED BY generate-tests.ts
// Source: src/services/imageProxyService.ts
// DO NOT EDIT MANUALLY - 修改将在下次生成时被覆盖

import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { imageProxyService } from '../../../src/services/imageProxyService';
import { supabase } from '../../../src/lib/supabase';

vi.mock('../../../src/lib/supabase', () => ({
  supabase: {
    auth: {
      getSession: vi.fn()
    }
  }
}));

// Mock global fetch
global.fetch = vi.fn();

describe('imageProxyService', () => {
  const originalImportMeta = globalThis.importMeta;
  const consoleErrorSpy = vi.spyOn(console, 'error').mockImplementation(() => {});

  afterEach(() => {
    vi.resetAllMocks();
    globalThis.importMeta = originalImportMeta;
  });

  describe('getProxyUrl', () => {
    const testCases = [
      { filePath: 'image.png', expected: 'https://example.com/functions/v1/proxy-image?path=image.png' },
      { filePath: 'folder/subfolder/image.jpg', expected: 'https://example.com/functions/v1/proxy-image?path=folder%2Fsubfolder%2Fimage.jpg' },
      { filePath: '', expected: 'https://example.com/functions/v1/proxy-image?path=' },
      { filePath: 'spécial chars &?=', expected: 'https://example.com/functions/v1/proxy-image?path=sp%C3%A9cial%20chars%20%26%3F%3D' }
    ];

    test.each(testCases)('returns correct proxy URL for filePath "$filePath"', async ({ filePath, expected }) => {
      globalThis.importMeta = { env: { VITE_SUPABASE_URL: 'https://example.com' } };
      const url = await imageProxyService.getProxyUrl(filePath);
      expect(url).toBe(expected);
    });

    it('returns empty string when VITE_SUPABASE_URL is not configured', async () => {
      globalThis.importMeta = { env: {} };
      const url = await imageProxyService.getProxyUrl('any.png');
      expect(url).toBe('');
      expect(consoleErrorSpy).toHaveBeenCalledWith('VITE_SUPABASE_URL 未配置');
    });
  });

  describe('getProxyUrlByFileId', () => {
    const testCases = [
      { fileId: '123', expected: 'https://example.com/functions/v1/proxy-image?fileId=123' },
      { fileId: 'abc-def', expected: 'https://example.com/functions/v1/proxy-image?fileId=abc-def' },
      { fileId: '', expected: 'https://example.com/functions/v1/proxy-image?fileId=' }
    ];

    test.each(testCases)('returns correct proxy URL for fileId "$fileId"', async ({ fileId, expected }) => {
      globalThis.importMeta = { env: { VITE_SUPABASE_URL: 'https://example.com' } };
      const url = await imageProxyService.getProxyUrlByFileId(fileId);
      expect(url).toBe(expected);
    });

    it('returns empty string when VITE_SUPABASE_URL is not configured', async () => {
      globalThis.importMeta = { env: {} };
      const url = await imageProxyService.getProxyUrlByFileId('any');
      expect(url).toBe('');
      expect(consoleErrorSpy).toHaveBeenCalledWith('VITE_SUPABASE_URL 未配置');
    });
  });

  describe('fetchImage', () => {
    const session = { access_token: 'dummy-token' };
    const blob = new Blob(['image data'], { type: 'image/png' });

    it('returns blob when session exists and fetch succeeds', async () => {
      supabase.auth.getSession.mockResolvedValue({ data: { session } });
      (global.fetch as vi.Mock).mockResolvedValue({
        ok: true,
        blob: vi.fn().mockResolvedValue(blob)
      });

      const result = await imageProxyService.fetchImage('path.png');
      expect(result.error).toBeNull();
      expect(result.data).toBe(blob);
    });

    it('returns error when no session', async () => {
      supabase.auth.getSession.mockResolvedValue({ data: { session: null } });

      const result = await imageProxyService.fetchImage('path.png');
      expect(result.data).toBeNull();
      expect(result.error).toBeInstanceOf(Error);
      expect(result.error?.message).toBe('未登录');
    });

    it('returns error when fetch response is not ok', async () => {
      supabase.auth.getSession.mockResolvedValue({ data: { session } });
      (global.fetch as vi.Mock).mockResolvedValue({
        ok: false,
        text: vi.fn().mockResolvedValue('Not Found')
      });

      const result = await imageProxyService.fetchImage('path.png');
      expect(result.data).toBeNull();
      expect(result.error).toBeInstanceOf(Error);
      expect(result.error?.message).toBe('获取图片失败: Not Found');
    });

    it('catches and returns error when fetch throws', async () => {
      supabase.auth.getSession.mockResolvedValue({ data: { session } });
      const fetchError = new Error('Network error');
      (global.fetch as vi.Mock).mockRejectedValue(fetchError);

      const result = await imageProxyService.fetchImage('path.png');
      expect(result.data).toBeNull();
      expect(result.error).toBe(fetchError);
    });
  });

  describe('fetchImageByFileId', () => {
    const session = { access_token: 'dummy-token' };
    const blob = new Blob(['image data'], { type: 'image/png' });

    it('returns blob when session exists and fetch succeeds', async () => {
      supabase.auth.getSession.mockResolvedValue({ data: { session } });
      (global.fetch as vi.Mock).mockResolvedValue({
        ok: true,
        blob: vi.fn().mockResolvedValue(blob)
      });

      const result = await imageProxyService.fetchImageByFileId('123');
      expect(result.error).toBeNull();
      expect(result.data).toBe(blob);
    });

    it('returns error when no session', async () => {
      supabase.auth.getSession.mockResolvedValue({ data: { session: null } });

      const result = await imageProxyService.fetchImageByFileId('123');
      expect(result.data).toBeNull();
      expect(result.error).toBeInstanceOf(Error);
      expect(result.error?.message).toBe('未登录');
    });

    it('returns error when fetch response is not ok', async () => {
      supabase.auth.getSession.mockResolvedValue({ data: { session } });
      (global.fetch as vi.Mock).mockResolvedValue({
        ok: false,
        text: vi.fn().mockResolvedValue('Server error')
      });

      const result = await imageProxyService.fetchImageByFileId('123');
      expect(result.data).toBeNull();
      expect(result.error).toBeInstanceOf(Error);
      expect(result.error?.message).toBe('获取图片失败: Server error');
    });

    it('catches and returns error when fetch throws', async () => {
      supabase.auth.getSession.mockResolvedValue({ data: { session } });
      const fetchError = new Error('Network error');
      (global.fetch as vi.Mock).mockRejectedValue(fetchError);

      const result = await imageProxyService.fetchImageByFileId('123');
      expect(result.data).toBeNull();
      expect(result.error).toBe(fetchError);
    });
  });
});