// AUTO-GENERATED BY generate-tests.ts
// Source: src/App.tsx
// DO NOT EDIT MANUALLY - 修改将在下次生成时被覆盖

import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { vi, describe, it, expect, beforeEach } from 'vitest';
import App from '../../src/App';

// Mock subcomponents
vi.mock('../../src/components/HomePage', () => ({
  default: () => null,
}));
vi.mock('../../src/components/ProjectsPage', () => ({
  default: () => null,
}));
vi.mock('../../src/components/LoginPage', () => ({
  default: () => null,
}));
vi.mock('../../src/components/SignUpPage', () => ({
  default: () => null,
}));
vi.mock('../../src/components/InitializingPage', () => ({
  default: () => null,
}));
vi.mock('../../src/components/ChatPanel', () => ({
  default: () => null,
}));
vi.mock('../../src/components/PreviewPanel', () => ({
  default: () => null,
}));
vi.mock('../../src/components/UserProfilePanel', () => ({
  default: () => null,
}));
vi.mock('../../src/components/VersionManager', () => ({
  default: () => null,
}));
vi.mock('../../src/components/ParticleField', () => ({
  default: () => null,
}));
vi.mock('../../src/components/VersionManagerPortal', () => ({
  default: () => null,
}));

// Mock context hooks
vi.mock('../../src/contexts/AuthContext', () => ({
  useAuth: vi.fn(),
}));
vi.mock('../../src/contexts/ProjectContext', () => ({
  useProject: vi.fn(),
}));
vi.mock('../../src/contexts/SettingsContext', () => ({
  useSettings: vi.fn(),
}));

// Mock utilities and services
vi.mock('../../src/services/titleService', () => ({
  titleService: {
    generateTitle: vi.fn(),
  },
}));
vi.mock('../../src/services/buildLogService', () => ({
  buildLogService: {
    addBuildLog: vi.fn(),
  },
}));
vi.mock('../../src/services/templateService', () => ({
  templateService: {
    initializeProjectWithTemplate: vi.fn(),
  },
}));
vi.mock('../../src/services/versionService', () => ({
  versionService: {
    getLatestVersion: vi.fn(),
  },
}));

// Helper to set up default mocks
function setupMocks(overrides = {}) {
  const defaultAuth = {
    user: null,
    loading: false,
    signOut: vi.fn(),
  };
  const defaultProject = {
    createProject: vi.fn(),
    currentProject: null,
    setCurrentProject: vi.fn(),
    updateProjectStatus: vi.fn(),
  };
  const defaultSettings = {
    preloadNodeModules: false,
    setPreloadNodeModules: vi.fn(),
  };

  vi.mocked(require('../../src/contexts/AuthContext').useAuth).mockReturnValue(
    { ...defaultAuth, ...overrides.auth }
  );
  vi.mocked(require('../../src/contexts/ProjectContext').useProject).mockReturnValue(
    { ...defaultProject, ...overrides.project }
  );
  vi.mocked(require('../../src/contexts/SettingsContext').useSettings).mockReturnValue(
    { ...defaultSettings, ...overrides.settings }
  );
}

describe('App component', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('renders loading spinner when auth loading is true', () => {
    setupMocks({ auth: { loading: true } });

    render(<App />);
    expect(screen.getByText('加载中...')).toBeInTheDocument();
  });

  it('shows LoginPage when user is not authenticated and authView is login', () => {
    setupMocks({ auth: { user: null, loading: false } });

    render(<App />);
    expect(screen.getByText('登录')).toBeInTheDocument(); // Assuming LoginPage renders a button with text "登录"
  });

  it('switches to SignUpPage when onSwitchToSignUp is clicked', () => {
    setupMocks({ auth: { user: null, loading: false } });

    // Mock LoginPage to expose the switch callback
    vi.mock('../../src/components/LoginPage', () => ({
      default: ({ onSwitchToSignUp }: any) => (
        <button onClick={onSwitchToSignUp}>Switch</button>
      ),
    }));

    render(<App />);
    fireEvent.click(screen.getByText('Switch'));
    expect(screen.getByText('注册')).toBeInTheDocument(); // Assuming SignUpPage renders a button with text "注册"
  });

  it('shows SignUpPage when authView is signup', () => {
    setupMocks({ auth: { user: null, loading: false } });

    // Mock SignUpPage to expose the switch callback
    vi.mock('../../src/components/SignUpPage', () => ({
      default: ({ onSwitchToLogin }: any) => (
        <button onClick={onSwitchToLogin}>Switch</button>
      ),
    }));

    render(<App />);
    // Simulate setting authView to signup via internal state (not directly accessible)
    // For this test we rely on the default flow: clicking switch on LoginPage
    fireEvent.click(screen.getByText('Switch'));
    expect(screen.getByText('登录')).toBeInTheDocument();
  });

  it('renders home view when user is authenticated', () => {
    setupMocks({ auth: { user: { email: 'test@example.com' }, loading: false } });

    render(<App />);
    expect(screen.getByText('test@example.com')).toBeInTheDocument();
  });

  it('navigates to ProjectsPage when "我的项目" button is clicked', async () => {
    setupMocks({ auth: { user: { email: 'test@example.com' }, loading: false } });

    // Mock ProjectsPage to render identifiable text
    vi.mock('../../src/components/ProjectsPage', () => ({
      default: () => <div>Projects Page Content</div>,
    }));

    render(<App />);
    fireEvent.click(screen.getByText('我的项目'));
    await waitFor(() => {
      expect(screen.getByText('Projects Page Content')).toBeInTheDocument();
    });
  });

  it('handles project click correctly', async () => {
    const setCurrentProject = vi.fn();
    const setCurrentView = vi.fn();

    // Mock useProject to expose setCurrentProject
    vi.mock('../../src/contexts/ProjectContext', () => ({
      useProject: vi.fn().mockReturnValue({
        createProject: vi.fn(),
        currentProject: null,
        setCurrentProject,
        updateProjectStatus: vi.fn(),
      }),
    }));

    // Mock useState for currentView
    vi.mock('react', () => ({
      ...jest.requireActual('react'),
      useState: (initial: any) => [initial, setCurrentView],
    }));

    setupMocks({ auth: { user: { email: 'test@example.com' }, loading: false } });

    // Mock HomePage to expose onProjectClick
    vi.mock('../../src/components/HomePage', () => ({
      default: ({ onProjectClick }: any) => (
        <button onClick={() => onProjectClick({ id: 'p1', title: 'Test Project' })}>
          Click Project
        </button>
      ),
    }));

    render(<App />);
    fireEvent.click(screen.getByText('Click Project'));

    expect(setCurrentProject).toHaveBeenCalledWith({ id: 'p1', title: 'Test Project' });
    expect(setCurrentView).toHaveBeenCalledWith('building');
  });

  it('handles back to home correctly', async () => {
    const setCurrentProject = vi.fn();
    const setCurrentView = vi.fn();

    // Mock useState for currentView
    vi.mock('react', () => ({
      ...jest.requireActual('react'),
      useState: (initial: any) => [initial, setCurrentView],
    }));

    // Mock useProject to expose setCurrentProject
    vi.mock('../../src/contexts/ProjectContext', () => ({
      useProject: vi.fn().mockReturnValue({
        createProject: vi.fn(),
        currentProject: { id: 'p1', title: 'Test Project' },
        setCurrentProject,
        updateProjectStatus: vi.fn(),
      }),
    }));

    setupMocks({ auth: { user: { email: 'test@example.com' }, loading: false } });

    // Mock building view back button
    vi.mock('../../src/components/ChatPanel', () => ({
      default: () => null,
    }));
    vi.mock('../../src/components/PreviewPanel', () => ({
      default: () => null,
    }));
    vi.mock('../../src/components/UserProfilePanel', () => ({
      default: () => null,
    }));
    vi.mock('../../src/components/VersionManager', () => ({
      default: () => null,
    }));

    // Render App and simulate that we are in building view
    render(<App />);
    // Click back button
    fireEvent.click(screen.getByTitle('返回主页'));

    expect(setCurrentProject).toHaveBeenCalledWith(null);
    expect(setCurrentView).toHaveBeenCalledWith('home');
  });

  it('start building flow succeeds and updates view correctly', async () => {
    const createProject = vi.fn().mockResolvedValue({
      data: { id: 'proj1', title: 'Generated Title' },
      error: null,
    });
    const addBuildLog = vi.fn().mockResolvedValue({});
    const updateProjectStatus = vi.fn().mockResolvedValue({});
    const initializeProjectWithTemplate = vi.fn().mockResolvedValue({
      success: true,
      error: null,
    });

    vi.mock('../../src/services/titleService', () => ({
      titleService: { 
        generateTitle: vi.fn().mockResolvedValue({ data: { title: 'Generated Title' }, error: null }),
      },
    }));
    vi.mock('../../src/services/buildLogService', () => ({
      buildLogService: { addBuildLog },
    }));
    vi.mock('../../src/services/templateService', () => ({
      templateService: { initializeProjectWithTemplate },
    }));
    vi.mock('../../src/services/versionService', () => ({
      versionService: { getLatestVersion: vi.fn() },
    }));

    // Mock HomePage to expose onStartBuilding
    vi.mock('../../src/components/HomePage', () => ({
      default: ({ onStartBuilding }: any) => (
        <button onClick={() => onStartBuilding('test prompt')}>Start</button>
      ),
    }));

    setupMocks({
      auth: { user: { email: 'test@example.com' }, loading: false },
      project: { createProject, updateProjectStatus },
    });

    render(<App />);
    fireEvent.click(screen.getByText('Start'));

    await waitFor(() => {
      expect(createProject).toHaveBeenCalledWith('Generated Title', 'test prompt');
      expect(addBuildLog).toHaveBeenCalledTimes(2); // info and success
      expect(updateProjectStatus).toHaveBeenCalledWith('proj1', 'completed');
    });
  });

  it('start building flow fails on template initialization and shows alert', async () => {
    const createProject = vi.fn().mockResolvedValue({
      data: { id: 'proj1', title: 'Generated Title' },
      error: null,
    });
    const addBuildLog = vi.fn().mockResolvedValue({});
    const updateProjectStatus = vi.fn().mockResolvedValue({});
    const initializeProjectWithTemplate = vi.fn().mockResolvedValue({
      success: false,
      error: 'Template error',
    });

    vi.mock('../../src/services/titleService', () => ({
      titleService: { 
        generateTitle: vi.fn().mockResolvedValue({ data: { title: 'Generated Title' }, error: null }),
      },
    }));
    vi.mock('../../src/services/buildLogService', () => ({
      buildLogService: { addBuildLog },
    }));
    vi.mock('../../src/services/templateService', () => ({
      templateService: { initializeProjectWithTemplate },
    }));
    vi.mock('../../src/services/versionService', () => ({
      versionService: { getLatestVersion: vi.fn() },
    }));

    // Mock alert
    global.alert = vi.fn();

    // Mock HomePage to expose onStartBuilding
    vi.mock('../../src/components/HomePage', () => ({
      default: ({ onStartBuilding }: any) => (
        <button onClick={() => onStartBuilding('test prompt')}>Start</button>
      ),
    }));

    setupMocks({
      auth: { user: { email: 'test@example.com' }, loading: false },
      project: { createProject, updateProjectStatus },
    });

    render(<App />);
    fireEvent.click(screen.getByText('Start'));

    await waitFor(() => {
      expect(initializeProjectWithTemplate).toHaveBeenCalled();
      expect(addBuildLog).toHaveBeenCalledWith('proj1', 'error', '初始化项目失败');
      expect(updateProjectStatus).toHaveBeenCalledWith('proj1', 'failed');
      expect(global.alert).toHaveBeenCalledWith('初始化项目失败，请重试');
    });
  });

  it('renders VersionManagerPortal when showVersionManager is true and currentProject exists', async () => {
    const setShowVersionManager = vi.fn();

    // Mock useState for showVersionManager
    vi.mock('react', () => ({
      ...jest.requireActual('react'),
      useState: (initial: any) => [initial, setShowVersionManager],
    }));

    // Mock VersionManagerPortal to render identifiable text
    vi.mock('../../src/components/VersionManagerPortal', () => ({
      default: () => <div>Version Manager Portal</div>,
    }));

    setupMocks({
      auth: { user: { email: 'test@example.com' }, loading: false },
      project: { currentProject: { id: 'p1', title: 'Test Project', status: 'completed' } },
    });

    render(<App />);

    // Simulate opening version manager
    setShowVersionManager(true);

    await waitFor(() => {
      expect(screen.getByText('Version Manager Portal')).toBeInTheDocument();
    });
  });
});
