# AI 自动测试生成器

本文档介绍如何使用 AI 自动测试生成器为项目源代码自动生成单元测试。

## 概述

AI 自动测试生成器是一个基于 OpenRouter API 的工具，它能够：

1. **自动扫描**：扫描 `src/` 目录下的所有 TypeScript 文件
2. **智能生成**：使用 AI 模型 (inception/mercury-coder) 为每个文件生成对应的 Vitest 测试代码
3. **增量更新**：通过哈希缓存机制，只更新发生变化的文件的测试
4. **自动同步**：当源文件被删除时，自动清理对应的测试文件

## 快速开始

### 前置条件

确保已设置 `OPENROUTER_KEY` 环境变量：

```bash
export OPENROUTER_KEY=your_openrouter_api_key
```

### 运行命令

```bash
# 生成所有测试（增量模式，只更新变化的文件）
npm run test:gen

# 强制重新生成所有测试
npm run test:gen:force

# 监听模式（文件变化时自动重新生成）
npm run test:gen:watch

# 生成特定文件的测试
npm run test:gen -- src/utils/titleGenerator.ts
```

## 工作原理

### 文件映射

源文件和测试文件的映射关系：

| 源文件路径 | 测试文件路径 |
|-----------|-------------|
| `src/utils/foo.ts` | `tests/generated/utils/foo.test.ts` |
| `src/components/Button.tsx` | `tests/generated/components/Button.test.tsx` |
| `src/services/api.ts` | `tests/generated/services/api.test.ts` |

### 增量更新机制

生成器使用 SHA-256 哈希来跟踪文件变化：

1. 首次运行时，为每个源文件生成测试并记录哈希值
2. 后续运行时，比较当前哈希与记录的哈希
3. 只有哈希值变化的文件才会重新生成测试
4. 元数据存储在 `tests/.generated-tests-meta.json`

### 文件类型识别

生成器会根据文件路径识别文件类型，并使用不同的测试策略：

| 文件类型 | 目录 | 测试策略 |
|---------|------|---------|
| 工具函数 | `utils/`, `lib/` | 纯函数测试，参数化测试 |
| React 组件 | `components/` | @testing-library/react 渲染测试 |
| 服务层 | `services/`, `realtime/` | Mock 外部依赖，测试成功/失败场景 |
| Context | `contexts/` | Provider 测试，状态管理测试 |

## 配置

配置文件位于 `tests/generator.config.json`：

```json
{
  "source": {
    "directory": "src",
    "include": ["**/*.ts", "**/*.tsx"],
    "exclude": ["**/*.d.ts", "**/main.tsx"]
  },
  "output": {
    "directory": "tests/generated",
    "metaFile": "tests/.generated-tests-meta.json"
  },
  "openRouter": {
    "model": "inception/mercury-coder",
    "temperature": 0.3,
    "maxTokens": 128000
  },
  "skipFiles": ["src/App.tsx"]
}
```

### 跳过特定文件

有两种方式跳过特定文件的测试生成：

1. **配置文件**：在 `skipFiles` 数组中添加文件路径
2. **源文件注释**：在源文件顶部添加 `// @no-auto-tests` 注释

## 目录结构

```
tests/
├── setup.ts                      # 测试环境配置（手动维护）
├── generator.config.json         # 生成器配置
├── .generated-tests-meta.json    # 生成器元数据（自动生成）
├── utils/                        # 手动编写的测试
│   └── titleGenerator.test.ts
└── generated/                    # AI 自动生成的测试
    ├── utils/
    │   └── titleGenerator.test.ts
    ├── components/
    │   └── ChatPanel.test.tsx
    └── services/
        └── messageService.test.ts
```

## 生成的测试文件格式

每个自动生成的测试文件都包含以下头部注释：

```typescript
// AUTO-GENERATED BY generate-tests.ts
// Source: src/utils/foo.ts
// DO NOT EDIT MANUALLY - 修改将在下次生成时被覆盖
```

## 最佳实践

### 手动测试 vs 自动生成测试

| 场景 | 推荐方式 |
|------|---------|
| 纯函数、工具类 | 自动生成 |
| 复杂业务逻辑 | 手动编写 |
| 边界情况测试 | 手动补充 |
| 集成测试 | 手动编写 |

### 工作流程建议

1. **初始化**：首次运行 `npm run test:gen` 生成所有测试
2. **开发中**：使用 `npm run test:gen:watch` 监听文件变化
3. **提交前**：运行 `npm run test` 确保所有测试通过
4. **代码审查**：检查生成的测试是否合理，必要时手动调整

### 处理生成失败

如果某个文件的测试生成失败：

1. 检查控制台错误信息
2. 确认 `OPENROUTER_KEY` 是否有效
3. 检查源文件是否有语法错误
4. 尝试使用 `--force` 重新生成

## 常见问题

### Q: 生成的测试质量如何保证？

A: 生成器使用精心设计的 prompt 来指导 AI 生成高质量测试，包括：
- BDD 风格的测试结构
- AAA 模式的测试用例
- 参数化测试覆盖多种输入
- 边界情况处理

但 AI 生成的测试可能不完美，建议：
- 运行测试确保能通过
- 审查关键业务逻辑的测试
- 必要时手动补充测试用例

### Q: 如何避免覆盖手动编写的测试？

A: 生成器只会操作 `tests/generated/` 目录下的文件，不会影响其他位置的测试文件。

### Q: API 调用费用如何？

A: 每个文件的测试生成大约消耗 1000-2000 tokens。建议：
- 使用增量模式避免重复生成
- 在 `skipFiles` 中排除不需要测试的文件
- 避免频繁使用 `--force` 选项

### Q: 监听模式会自动运行测试吗？

A: 不会。监听模式只负责生成测试文件，你需要在另一个终端运行 `npm run test:watch` 来自动运行测试。

## 技术细节

### 依赖

- `tsx`: TypeScript 执行器
- `chokidar`: 文件监听库
- `crypto`: 哈希计算

### API 配置

- 端点: `https://openrouter.ai/api/v1/chat/completions`
- 模型: `inception/mercury-coder`
- Temperature: 0.3（较低以保证一致性）

### 限流

为避免 API 限流，生成器在每次成功生成后会等待 1 秒再处理下一个文件。
